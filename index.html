<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InboxIQ User Email Manager</title>
    <!-- Firebase SDK -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.22.2/firebase-firestore-compat.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .dashboard {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .dashboard-header {
            background-color: #4285f4;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .dashboard-title {
            font-size: 24px;
            font-weight: 500;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-email {
            font-size: 14px;
        }

        .back-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: none;
        }

        .back-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .logout-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .logout-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .dashboard-controls {
            display: flex;
            gap: 10px;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .search-input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            flex-grow: 1;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            background-color: white;
        }

        .refresh-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #34a853;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .refresh-button:hover {
            background-color: #2d9349;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .stat-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            margin: 10px 0;
            color: #4285f4;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .app-insights {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .app-insights-title {
            font-size: 18px;
            margin-bottom: 15px;
            color: #555;
        }

        .app-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }

        .app-tag {
            padding: 5px 10px;
            background-color: #e8f0fe;
            color: #4285f4;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .app-tag:hover {
            background-color: #d2e3fc;
        }

        .app-tag.selected {
            background-color: #4285f4;
            color: white;
        }

        .email-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            min-height: 600px;
        }

        .email-list {
            border-right: 1px solid #eee;
            overflow-y: auto;
            max-height: 600px;
        }

        .email-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .email-item:hover {
            background-color: #f1f3f4;
        }

        .email-item.selected {
            background-color: #e8f0fe;
        }

        .email-sender {
            font-weight: 500;
            margin-bottom: 5px;
        }

        .email-subject {
            color: #555;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-bottom: 5px;
        }

        .email-apps {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 8px;
        }

        .email-app-tag {
            padding: 2px 8px;
            background-color: #e8f0fe;
            color: #4285f4;
            border-radius: 15px;
            font-size: 11px;
        }

        .email-detail {
            padding: 20px;
            overflow-y: auto;
            max-height: 600px;
        }

        .email-detail-header {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .email-detail-subject {
            font-size: 22px;
            font-weight: 500;
            margin-bottom: 10px;
        }

        .email-detail-metadata {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 15px;
            color: #666;
        }

        .email-detail-apps {
            margin-top: 15px;
        }

        .email-detail-apps-title {
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
        }

        .email-detail-apps-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .email-detail-app {
            padding: 5px 10px;
            background-color: #e8f0fe;
            color: #4285f4;
            border-radius: 20px;
            font-size: 13px;
        }

        .email-detail-content {
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .loading, .error, .no-emails, .no-email-selected {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            color: #666;
            font-size: 18px;
        }

        .error {
            color: #ea4335;
        }

        /* User list styles */
        .user-list-container {
            padding: 20px;
        }

        .user-list-title {
            font-size: 20px;
            margin-bottom: 20px;
            color: #555;
        }

        .user-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }

        .user-card {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .user-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .user-card-email {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #4285f4;
        }

        .user-card-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .email-container {
                grid-template-columns: 1fr;
            }
            
            .email-list {
                border-right: none;
                border-bottom: 1px solid #eee;
                max-height: 300px;
            }
            
            .dashboard-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .user-info {
                margin-top: 10px;
            }
            
            .dashboard-controls {
                flex-wrap: wrap;
            }
            
            .search-input {
                width: 100%;
                margin-bottom: 10px;
            }

            .user-list {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <div class="dashboard-header">
                <div class="dashboard-title">InboxIQ User Email Manager</div>
                <div class="user-info">
                    <span class="user-email" id="user-email">Select a user</span>
                    <button id="back-button" class="back-button">Back to Users</button>
                    <a href="/logout" class="logout-button">Logout</a>
                </div>
            </div>

            <!-- User List View -->
            <div id="user-list-view">
                <div class="dashboard-controls">
                    <input type="text" id="user-search-input" class="search-input" placeholder="Search users...">
                    <button id="refresh-users-button" class="refresh-button">Refresh</button>
                </div>

                <div class="user-list-container">
                    <div class="user-list-title">Compromised Users</div>
                    <div id="loading-users" class="loading">Loading users...</div>
                    <div id="error-users" class="error" style="display: none;"></div>
                    <div id="user-list" class="user-list" style="display: none;"></div>

                </div>
            </div>

            <!-- Email View (initially hidden) -->
            <div id="email-view" style="display: none;">
                <div class="dashboard-controls">
                    <input type="text" id="search-input" class="search-input" placeholder="Search emails or apps...">
                    <select id="filter-select" class="filter-select">
                        <option value="all">All Apps</option>
                        <!-- App options will be dynamically added here -->
                    </select>
                    <button id="delete-button" class="delete-button">Delete Mails</button>
                    <button id="refresh-button" class="refresh-button">Refresh</button>
                </div>

                <div class="dashboard-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Emails with 3rd Party Apps</div>
                        <div class="stat-value" id="total-emails">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Unique 3rd Party Apps</div>
                        <div class="stat-value" id="unique-apps">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Most Common App</div>
                        <div class="stat-value" id="most-common-app">-</div>
                    </div>
                </div>

                <div class="app-insights">
                    <div class="app-insights-title">Popular Third-Party Apps</div>
                    <div class="app-tags" id="app-tags">
                        <!-- App tags will be dynamically added here -->
                    </div>
                </div>

                <div id="loading" class="loading">Loading emails...</div>
                <div id="error" class="error" style="display: none;"></div>
                
                <div id="email-container" class="email-container" style="display: none;">
                    <div id="email-list" class="email-list"></div>
                    <div id="email-detail" class="email-detail">
                        <div class="no-email-selected">Select an email to view its contents</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

        <script>
            // Add mock data for testing if Firestore connection fails
            const mockUsers = [
                { email: "john.doe@example.com", emailCount: 12, uniqueAppCount: 5 },
                { email: "jane.smith@example.com", emailCount: 8, uniqueAppCount: 3 },
                { email: "robert.johnson@example.com", emailCount: 15, uniqueAppCount: 7 },
                { email: "sarah.williams@example.com", emailCount: 6, uniqueAppCount: 2 },
                { email: "michael.brown@example.com", emailCount: 9, uniqueAppCount: 4 }
            ];
            
            const mockEmails = [
                {
                    id: "email1",
                    messageId: "msg_123456",
                    subject: "Meeting with Client",
                    sender: "client@company.com",
                    body: "Let's discuss the project details tomorrow at 10 AM.",
                    apps: ["Zoom", "Calendar", "Slack"],
                    timestamp: new Date()
                },
                {
                    id: "email2",
                    messageId: "msg_789012",
                    subject: "Project Update",
                    sender: "manager@company.com",
                    body: "Please find attached the latest project report.",
                    apps: ["Dropbox", "Asana"],
                    timestamp: new Date()
                },
                {
                    id: "email3",
                    messageId: "msg_345678",
                    subject: "Invoice #1234",
                    sender: "billing@supplier.com",
                    body: "Your invoice is due in 7 days.",
                    apps: ["QuickBooks", "PayPal"],
                    timestamp: new Date()
                }
            ];
        
            // Initialize Firebase
            const firebaseConfig = {
                apiKey: "AIzaSyDpp8drX0LVx-xy3YCWnqBpIg4laMmqeG4",
                authDomain: "app-be96d.firebaseapp.com",
                projectId: "app-be96d",
                storageBucket: "app-be96d.firebasestorage.app",
                messagingSenderId: "211546451764",
                appId: "1:211546451764:web:d5e7e658feaf2e83b2bf61"
            };
            
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            // DOM Elements - User List View
            const userListViewEl = document.getElementById('user-list-view');
            const userListEl = document.getElementById('user-list');
            const loadingUsersEl = document.getElementById('loading-users');
            const errorUsersEl = document.getElementById('error-users');
            const userSearchInputEl = document.getElementById('user-search-input');
            const refreshUsersButtonEl = document.getElementById('refresh-users-button');
        
            // DOM Elements - Email View
            const emailViewEl = document.getElementById('email-view');
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const emailContainerEl = document.getElementById('email-container');
            const emailListEl = document.getElementById('email-list');
            const emailDetailEl = document.getElementById('email-detail');
            const searchInputEl = document.getElementById('search-input');
            const filterSelectEl = document.getElementById('filter-select');
            const refreshButtonEl = document.getElementById('refresh-button');
            const deleteButtonEl = document.getElementById('delete-button');
            const totalEmailsEl = document.getElementById('total-emails');
            const uniqueAppsEl = document.getElementById('unique-apps');
            const mostCommonAppEl = document.getElementById('most-common-app');
            const appTagsEl = document.getElementById('app-tags');
            const userEmailEl = document.getElementById('user-email');
            const backButtonEl = document.getElementById('back-button');
            
            // State
            let users = [];
            let userSearchTerm = '';
            let selectedUserEmail = null;
            let selectedUserData = null;
            
            let emails = [];
            let selectedEmailId = null;
            let searchTerm = '';
            let filterValue = 'all';
            let selectedAppTag = null;
            
            // Event Listeners - User List
            userSearchInputEl.addEventListener('input', (e) => {
                userSearchTerm = e.target.value.toLowerCase();
                renderUserList();
            });
            
            refreshUsersButtonEl.addEventListener('click', fetchUsers);
            
            // Event Listeners - Email View
            backButtonEl.addEventListener('click', () => {
                showUserListView();
            });
            
            searchInputEl.addEventListener('input', (e) => {
                searchTerm = e.target.value.toLowerCase();
                renderEmailList();
            });
            
            filterSelectEl.addEventListener('change', (e) => {
                filterValue = e.target.value;
                selectedAppTag = null;
                updateAppTagSelection();
                renderEmailList();
            });
            
            refreshButtonEl.addEventListener('click', () => {
                fetchEmails(selectedUserEmail);
            });
            
            deleteButtonEl.addEventListener('click', () => {
                if (!selectedUserData) {
                    // Try to fetch user data first if it's not available
                    fetchUserData(selectedUserEmail).then(userData => {
                        if (userData) {
                            selectedUserData = userData;
                            deleteAllEmails();
                        }
                    });
                } else {
                    deleteAllEmails();
                }
            });
            
            // Functions - View Management
            function showUserListView() {
                userListViewEl.style.display = 'block';
                emailViewEl.style.display = 'none';
                backButtonEl.style.display = 'none';
                userEmailEl.textContent = 'Select a user';
                selectedUserEmail = null;
                selectedUserData = null;
            }
            
            function showEmailView(userEmail) {
                userListViewEl.style.display = 'none';
                emailViewEl.style.display = 'block';
                backButtonEl.style.display = 'inline-block';
                userEmailEl.textContent = userEmail;
                selectedUserEmail = userEmail;
                
                // Reset email view state
                emails = [];
                selectedEmailId = null;
                searchTerm = '';
                filterValue = 'all';
                selectedAppTag = null;
                
                // Clear UI elements
                searchInputEl.value = '';
                filterSelectEl.value = 'all';
                
                // Fetch user data (for tokens) then fetch emails
                fetchUserData(userEmail).then(userData => {
                    // Store user data globally
                    selectedUserData = userData;
                    // Then fetch emails
                    fetchEmails(userEmail);
                });
            }
            
            // Function to fetch user data including tokens - simplified to use prompt
          // Function to fetch user data including tokens from Firestore users collection
async function fetchUserData(userEmail) {
    try {
        console.log(`Fetching data for user: ${userEmail}`);
        
        // Direct document lookup using email as the document ID
        const userDoc = await db.collection('users').doc(userEmail).get();
        
        // If direct document lookup fails, try querying by email field
        if (!userDoc.exists) {
            console.log("User document not found by direct ID, trying query...");
            const userQuery = db.collection('users').where('email', '==', userEmail);
            const userSnapshot = await userQuery.get();
            
            if (userSnapshot.empty) {
                console.log(`No user data found for ${userEmail}`);
                
                // Fallback to prompt if needed
                const usePrompt = confirm("User authentication data not found. Would you like to enter an access token manually?");
                if (usePrompt) {
                    const token = prompt("Enter your Gmail API access token:", "");
                    if (token) {
                        return {
                            email: userEmail,
                            access_token: token
                        };
                    }
                }
                
                alert(`No authentication data found for ${userEmail}. Cannot delete emails.`);
                return null;
            }
            
            // Get the first matching document
            const userData = userSnapshot.docs[0].data();
            console.log(`User authentication data retrieved for: ${userEmail}`);
            return userData;
        }
        
        // If direct document lookup succeeds
        const userData = userDoc.data();
        console.log(`User authentication data retrieved for: ${userEmail}`);
        return userData;
    } catch (err) {
        console.error("Error fetching user data:", err);
        
        // Handle permission errors
        if (err.code === 'permission-denied') {
            alert("Permission denied when accessing user data. Please check your database rules.");
            
            // Fallback to prompt
            const usePrompt = confirm("Would you like to enter an access token manually?");
            if (usePrompt) {
                const token = prompt("Enter your Gmail API access token:", "");
                if (token) {
                    return {
                        email: userEmail,
                        access_token: token
                    };
                }
            }
        } else {
            alert(`Error accessing authentication data: ${err.message}`);
        }
        
        return null;
    }
}
const hardcodedUsers = [
{ email: "robert.johnson@companymail.com", emailCount: 37, uniqueAppCount: 12 },
{ email: "sarah.williams@enterprise-corp.net", emailCount: 29, uniqueAppCount: 8 },
{ email: "michael.brown@techfirm.org", emailCount: 45, uniqueAppCount: 15 },
{ email: "jennifer.davis@global-systems.com", emailCount: 18, uniqueAppCount: 6 },
{ email: "david.miller@dataworks.io", emailCount: 52, uniqueAppCount: 17 },
{ email: "lisa.garcia@securecloud.net", emailCount: 23, uniqueAppCount: 9 },
{ email: "james.rodriguez@intellisys.org", emailCount: 31, uniqueAppCount: 11 },
{ email: "michelle.wilson@nextech.com", emailCount: 42, uniqueAppCount: 14 },
{ email: "thomas.martinez@softdev.co", emailCount: 16, uniqueAppCount: 5 },
{ email: "jessica.anderson@innovatech.io", emailCount: 34, uniqueAppCount: 10 },
{ email: "christopher.taylor@smartsolutions.net", emailCount: 27, uniqueAppCount: 7 },
{ email: "amanda.thomas@quantumdata.org", emailCount: 39, uniqueAppCount: 13 }
];

            // Functions - User List
            async function fetchUsers() {
                try {
                    console.log("Starting fetchUsers function");
                    
                    // Make sure elements exist before accessing them
                    if (!loadingUsersEl || !userListEl || !errorUsersEl) {
                        console.error("DOM elements not found, retrying in 500ms");
                        setTimeout(fetchUsers, 500);
                        return;
                    }
                    
                    loadingUsersEl.style.display = 'flex';
                    userListEl.style.display = 'none';
                    errorUsersEl.style.display = 'none';
                    
                    console.log("Querying Firestore for users with third-party app emails");
                    
                    // Get distinct users who have emails with third-party apps
                    const emailsRef = db.collection('emails')
                        .where('has_third_party_apps', '==', true)
                        .limit(100);
                    
                    console.log("Awaiting Firestore results...");
                    let firestoreUsers = [];
                    
                    try {
                        const snapshot = await emailsRef.get();
                        console.log(`Received ${snapshot.size} documents from Firestore`);
                        
                        // Extract unique user emails and count their emails with third-party apps
                        const userEmailMap = {};
                        
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const userEmail = data.user_email;
                            
                            if (userEmail) {
                                if (!userEmailMap[userEmail]) {
                                    userEmailMap[userEmail] = {
                                        email: userEmail,
                                        emailCount: 0,
                                        appSet: new Set()
                                    };
                                }
                                
                                userEmailMap[userEmail].emailCount++;
                                
                                // Track unique apps for this user
                                if (data.detected_apps && Array.isArray(data.detected_apps)) {
                                    data.detected_apps.forEach(app => {
                                        userEmailMap[userEmail].appSet.add(app);
                                    });
                                }
                            }
                        });
                        
                        // Convert to array
                        firestoreUsers = Object.values(userEmailMap).map(user => ({
                            email: user.email,
                            emailCount: user.emailCount,
                            uniqueAppCount: user.appSet.size
                        }));
                        
                        console.log(`Processed ${firestoreUsers.length} unique users with third-party app emails`);
                    } catch (err) {
                        console.error("Error fetching users from Firestore:", err);
                        firestoreUsers = []; // Reset to empty array if there was an error
                    }
                    
                    // Combine Firestore users with hardcoded users
                    // Always include hardcoded users, but ensure we don't duplicate emails
                    const existingEmails = new Set(firestoreUsers.map(user => user.email));
                    
                    // Only add hardcoded users whose emails don't exist in Firestore results
                    const uniqueHardcodedUsers = hardcodedUsers.filter(user => !existingEmails.has(user.email));
                    
                    // Combine the lists
                    users = [...firestoreUsers, ...uniqueHardcodedUsers];
                    
                    // Sort by email count (descending)
                   // users.sort((a, b) => b.emailCount - a.emailCount);
                    
                    console.log(`Total users to display: ${users.length}`);
                    
                    // Always render the list, even if Firestore returned no users
                    renderUserList();
                    
                    loadingUsersEl.style.display = 'none';
                    userListEl.style.display = 'grid';
                    console.log("User list displayed");
                } catch (err) {
                    console.error("Error in fetchUsers function:", err);
                    loadingUsersEl.style.display = 'none';
                    errorUsersEl.style.display = 'flex';
                    errorUsersEl.textContent = "Failed to load users: " + err.message;
                    
                    // Use hardcoded users as fallback in case of complete failure
                    users = [...hardcodedUsers];
                    renderUserList();
                    
                    loadingUsersEl.style.display = 'none';
                    userListEl.style.display = 'grid';
                    console.log("Fallback to hardcoded user list");
                }
            }
            
            function renderUserList() {
                console.log(`Rendering user list with ${users.length} users`);
                
                // Filter users by search term if provided
                const filteredUsers = userSearchTerm 
                    ? users.filter(user => user.email.toLowerCase().includes(userSearchTerm))
                    : users;
                
                console.log(`After filtering: ${filteredUsers.length} users match search criteria`);
                
                if (filteredUsers.length === 0) {
                    userListEl.innerHTML = '<div class="no-emails">No users found</div>';
                    return;
                }
                
                userListEl.innerHTML = '';
                
                // If we still have no users, use mock data as fallback
                if (filteredUsers.length === 0 && mockUsers && mockUsers.length > 0) {
                    console.log("Using mock users as fallback");
                    mockUsers.forEach(createUserCard);
                    return;
                }
                
                filteredUsers.forEach(createUserCard);
            }
            
            function createUserCard(user) {
                const userCardEl = document.createElement('div');
                userCardEl.className = 'user-card';
                
                userCardEl.innerHTML = `
                    <div class="user-card-email">${user.email}</div>
                    <div class="user-card-stats">
                        <span>${user.emailCount} emails</span>
                        <span>${user.uniqueAppCount} unique apps</span>
                    </div>
                `;
                
                
                userCardEl.addEventListener('click', () => {
                    showEmailView(user.email);
                });
                
                userListEl.appendChild(userCardEl);
                



            }
            
            // Functions - Email View
            async function fetchEmails(userEmail) {
                console.log(`Fetching emails for user: ${userEmail}`);
                if (!userEmail) {
                    console.error("No user email provided");
                    return;
                }
                
                try {
                    loadingEl.style.display = 'flex';
                    emailContainerEl.style.display = 'none';
                    errorEl.style.display = 'none';
                    
                    // Check if we should use mock data (for testing or if Firebase fails)
                    const useMockData = location.search.includes('mock=true') || 
                                      localStorage.getItem('useMockData') === 'true';
                    
                    if (useMockData) {
                        console.log("Using mock email data");
                        setTimeout(() => {
                            emails = [...mockEmails]; // Create a copy
                            updateStats();
                            updateAppTags();
                            updateFilterOptions();
                            renderEmailList();
                            
                            loadingEl.style.display = 'none';
                            emailContainerEl.style.display = 'grid';
                        }, 500);
                        return;
                    }
                    
                    console.log("Querying Firestore for emails");
                    // Filter emails by user email
                    const emailsRef = db.collection('emails')
                        .where('user_email', '==', userEmail)
                        .where('has_third_party_apps', '==', true)
                        .limit(100);
                    
                    console.log("Awaiting Firestore results...");
                    const snapshot = await emailsRef.get();
                    console.log(`Received ${snapshot.size} emails from Firestore`);
                    
                    emails = [];
                    snapshot.forEach((doc) => {
                        const data = doc.data();
                        emails.push({
                            id: doc.id,
                            messageId: data.email_id || '', // Using email_id as messageId
                            subject: data.subject || 'No Subject',
                            sender: data.sender || 'Unknown Sender',
                            body: data.body || '',
                            apps: data.detected_apps || [],
                            timestamp: data.created_at ? 
                                (typeof data.created_at.toDate === 'function' ? data.created_at.toDate() : new Date(data.created_at)) 
                                : new Date()
                        });
                    });
                    
                    if (emails.length === 0) {
                        errorEl.style.display = 'flex';
                        errorEl.textContent = `No emails with third-party apps found for ${userEmail}`;
                        loadingEl.style.display = 'none';
                        return;
                    }
                    
                    updateStats();
                    updateAppTags();
                    updateFilterOptions();
                    renderEmailList();
                    
                    loadingEl.style.display = 'none';
                    emailContainerEl.style.display = 'grid';
                } catch (err) {
                    console.error("Error fetching emails:", err);
                    loadingEl.style.display = 'none';
                    errorEl.style.display = 'flex';
                    errorEl.textContent = "Failed to load emails: " + err.message;
                }
            }
            
            function updateStats() {
                const totalEmails = emails.length;
                
                // Count unique apps
                const allApps = emails.flatMap(email => email.apps);
                const uniqueApps = [...new Set(allApps)];
                
                // Find most common app
                const appCounts = {};
                allApps.forEach(app => {
                    appCounts[app] = (appCounts[app] || 0) + 1;
                });
                
                let mostCommonApp = '-';
                let maxCount = 0;
                
                Object.entries(appCounts).forEach(([app, count]) => {
                    if (count > maxCount) {
                        mostCommonApp = app;
                        maxCount = count;
                    }
                });
                
                totalEmailsEl.textContent = totalEmails;
                uniqueAppsEl.textContent = uniqueApps.length;
                mostCommonAppEl.textContent = mostCommonApp !== '-' ? mostCommonApp : '-';
            }
            
            function updateAppTags() {
                // Get all unique apps
                const allApps = emails.flatMap(email => email.apps);
                const uniqueApps = [...new Set(allApps)];
                
                // Count occurrences
                const appCounts = {};
                allApps.forEach(app => {
                    appCounts[app] = (appCounts[app] || 0) + 1;
                });
                
                // Sort by occurrence count
                const sortedApps = uniqueApps.sort((a, b) => appCounts[b] - appCounts[a]);
                
                // Take top 10
                const topApps = sortedApps.slice(0, 10);
                
                // Create app tags
                appTagsEl.innerHTML = '';
                topApps.forEach(app => {
                    const tagEl = document.createElement('div');
                    tagEl.className = `app-tag ${app === selectedAppTag ? 'selected' : ''}`;
                    tagEl.textContent = `${app} (${appCounts[app]})`;
                    
                    tagEl.addEventListener('click', () => {
                        if (selectedAppTag === app) {
                            // Deselect if already selected
                            selectedAppTag = null;
                            filterValue = 'all';
                            filterSelectEl.value = 'all';
                        } else {
                            // Select this app
                            selectedAppTag = app;
                            filterValue = app;
                        }
                        
                        updateAppTagSelection();
                        renderEmailList();
                    });
                    
                    appTagsEl.appendChild(tagEl);
                });
            }
            
            function updateAppTagSelection() {
                // Update visual selection of app tags
                const tagElements = appTagsEl.querySelectorAll('.app-tag');
                tagElements.forEach(tag => {
                    const appName = tag.textContent.split(' (')[0];
                    if (appName === selectedAppTag) {
                        tag.classList.add('selected');
                    } else {
                        tag.classList.remove('selected');
                    }
                });
            }
            
            function updateFilterOptions() {
                // Get all unique apps for the filter dropdown
                const allApps = emails.flatMap(email => email.apps);
                const uniqueApps = [...new Set(allApps)].sort();
                
                // Clear existing options (except 'All Apps')
                while (filterSelectEl.options.length > 1) {
                    filterSelectEl.remove(1);
                }
                
                // Add app options
                uniqueApps.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app;
                    option.textContent = app;
                    filterSelectEl.appendChild(option);
                });
            }
            
            function filterEmails() {
                return emails.filter(email => {
                    // Apply app filter
                    if (filterValue !== 'all' && !email.apps.includes(filterValue)) {
                        return false;
                    }
                    
                    // Apply search term
                    if (searchTerm) {
                        const hasMatchingSubject = email.subject.toLowerCase().includes(searchTerm);
                        const hasMatchingSender = email.sender.toLowerCase().includes(searchTerm);
                        const hasMatchingBody = email.body.toLowerCase().includes(searchTerm);
                        const hasMatchingApp = email.apps.some(app => app.toLowerCase().includes(searchTerm));
                        
                        return hasMatchingSubject || hasMatchingSender || hasMatchingBody || hasMatchingApp;
                    }
                    
                    return true;
                });
            }
        
            async function deleteEmailFromGmail(messageId) {
                if (!selectedUserData || !selectedUserData.access_token) {
                    console.log("No access token available for this user");
                    return { success: false, error: "No access token available" };
                }
                
                try {
                    console.log(`Deleting email with message ID: ${messageId}`);
                    
                    // For test purposes, simulate success if no message ID
                    if (!messageId || messageId.trim() === '') {
                        console.log("No message ID provided, simulating success");
                        return { success: true, data: { id: "simulated_" + Date.now() } };
                    }
                    console.log("hii");
                    console.log(selectedUserData.access_token);

                    const response = await fetch(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${messageId}/trash`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${selectedUserData.access_token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Gmail API Error:", errorData);
                        
                        // Check if token is expired (401 Unauthorized)
                        
                        if (response.status === 401) {
                            console.log("token is")
                            console.log(selectedUserData.access_token)
                            alert("Access token is invalid or expired. Please provide a new token.");
                            
                            // Ask for a new token
                            const newToken = prompt("Your access token is invalid. Please provide a new Gmail API access token:", "");
                            if (newToken) {
                                selectedUserData.access_token = newToken;
                                // Retry with new token
                                return deleteEmailFromGmail(messageId);
                            } else {
                                return { success: false, error: "Authorization failed and no new token provided" };
                            }
                        }
                        
                        return { 
                            success: false, 
                            error: errorData.error ? errorData.error.message : "Unknown API error" 
                        };
                    }
                    
                    const data = await response.json();
                    console.log("Gmail API Response:", data);
                    
                    return { success: true, data };
                } catch (err) {
                    console.error("Error deleting email:", err);
                    return { success: false, error: err.message };
                }
            }
        
            async function deleteAllEmails() {
                // Show confirmation dialog
                if (!confirm("Are you sure you want to delete ALL emails with third-party apps? This action cannot be undone.")) {
                    return;
                }
                
                // Check for token
                if (!selectedUserData || !selectedUserData.access_token) {
                    console.log("No access token available");
                    
                    const token = prompt("Please enter your Gmail API access token to delete emails:", "");
                    if (!token) {
                        alert("Cannot delete emails without an access token.");
                        return;
                    }
                    
                    selectedUserData = {
                        email: selectedUserEmail,
                        access_token: token
                    };
                }
                
                // Filter only deletable emails (ones with message IDs)
                const emailsToDelete = emails.filter(email => email.messageId);
                
                if (emailsToDelete.length === 0) {
                    alert("No emails with message IDs found. Cannot delete emails.");
                    return;
                }
                
                const totalToDelete = emailsToDelete.length;
                let successCount = 0;
                let failureCount = 0;
                
                // Show progress notification
                console.log(`Deleting ${totalToDelete} emails...`);
                
                // Create a progress indicator
                const progressContainer = document.createElement('div');
                progressContainer.id = 'delete-progress';
                progressContainer.style.position = 'fixed';
                progressContainer.style.top = '50%';
                progressContainer.style.left = '50%';
                progressContainer.style.transform = 'translate(-50%, -50%)';
                progressContainer.style.backgroundColor = 'white';
                progressContainer.style.padding = '20px';
                progressContainer.style.borderRadius = '8px';
                progressContainer.style.boxShadow = '0 4px 20px rgba(0, 0, 0, 0.2)';
                progressContainer.style.zIndex = '2000';
                progressContainer.innerHTML = `
                    <h3>Deleting Emails</h3>
                    <div>Progress: <span id="delete-progress-count">0</span> / ${totalToDelete}</div>
                    <div style="margin-top: 15px;">Please don't close this window</div>
                `;
                document.body.appendChild(progressContainer);
                
                // Get progress count element
                const progressCountEl = document.getElementById('delete-progress-count');
                
                // Process emails in batches of 5 to avoid rate limits
                const batchSize = 5;
                
                for (let i = 0; i < emailsToDelete.length; i += batchSize) {
                    // Get current batch
                    const batch = emailsToDelete.slice(i, i + batchSize);
                    
                    // Process batch in parallel
                    const results = await Promise.all(
                        batch.map(async (email) => {
                            const result = await deleteEmailFromGmail(email.messageId);
                            
                            if (result.success) {
                                // Update Firestore to mark as deleted
                                try {
                                    const emailRef = db.collection('emails').doc(email.id);
                                    await emailRef.update({
                                        deleted: true,
                                        deleted_at: new Date()
                                    });
                                } catch (err) {
                                    console.error(`Error updating Firestore for email ${email.id}:`, err);
                                }
                                
                                return { success: true, id: email.id };
                            } else {
                                return { success: false, id: email.id, error: result.error };
                            }
                        })
                    );
                    
                    // Update counts
                    results.forEach(result => {
                        if (result.success) {
                            successCount++;
                        } else {
                            failureCount++;
                        }
                    });
                    
                    // Update progress
                    progressCountEl.textContent = successCount;
                    
                    // Wait a bit between batches to avoid rate limits
                    if (i + batchSize < emailsToDelete.length) {
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }
                }
                
                // Remove progress indicator
                progressContainer.remove();
                
                // Show completion toast
                if (failureCount === 0) {
                    alert(`Successfully deleted ${successCount} emails`);
                } else {
                    alert(`Deleted ${successCount} emails, ${failureCount} failed`);
                }
                
                // Reload the email list if any were deleted
                if (successCount > 0) {
                    fetchEmails(selectedUserEmail);
                }
            }
            
            function renderEmailList() {
                const filteredEmails = filterEmails();
                
                if (filteredEmails.length === 0) {
                    emailListEl.innerHTML = '<div class="no-emails">No emails found</div>';
                    emailDetailEl.innerHTML = '<div class="no-email-selected">No emails match your filters</div>';
                    return;
                }
                
                emailListEl.innerHTML = '';
                
                filteredEmails.forEach(email => {
                    const emailItemEl = document.createElement('div');
                    emailItemEl.className = `email-item ${email.id === selectedEmailId ? 'selected' : ''}`;
                    
                    // Create app tags HTML
                    const appTagsHtml = email.apps.map(app => 
                        `<span class="email-app-tag">${app}</span>`
                    ).join('');
                    
                    emailItemEl.innerHTML = `
                        <div class="email-sender">${email.sender}</div>
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-apps">${appTagsHtml}</div>
                    `;
                    
                    emailItemEl.addEventListener('click', () => {
                        selectEmail(email);
                    });
                    
                    emailListEl.appendChild(emailItemEl);
                });
                
                // If no email is selected but we have emails, select the first one
                if (!selectedEmailId && filteredEmails.length > 0) {
                    selectEmail(filteredEmails[0]);
                } else if (selectedEmailId) {
                    // Check if selected email is still in filtered list
                    const isSelectedEmailInList = filteredEmails.some(email => email.id === selectedEmailId);
                    if (!isSelectedEmailInList && filteredEmails.length > 0) {
                        selectEmail(filteredEmails[0]);
                    } else if (!isSelectedEmailInList) {
                        emailDetailEl.innerHTML = '<div class="no-email-selected">No emails match your filters</div>';
                    }
                }
            }
            
            function selectEmail(email) {
                selectedEmailId = email.id;
                
                // Update visual selection
                const emailItems = emailListEl.querySelectorAll('.email-item');
                emailItems.forEach(item => {
                    item.classList.remove('selected');
                    if (item.querySelector('.email-subject').textContent === email.subject) {
                        item.classList.add('selected');
                    }
                });
                
                // Create app tags HTML
                const appTagsHtml = email.apps.map(app => 
                    `<div class="email-detail-app">${app}</div>`
                ).join('');
                
                // Format date
                const formattedDate = email.timestamp ? email.timestamp.toLocaleString() : 'Unknown date';
                
                // Sanitize and format email body
                const sanitizedBody = email.body
                    ? email.body.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>")
                    : "No content";
        
                // Show message ID for debugging purposes 
                const messageIdInfo = email.messageId ? 
                    `<div style="margin-top:5px; font-size:11px; color:#888;">Message ID: ${email.messageId}</div>` : 
                    `<div style="margin-top:5px; font-size:11px; color:#ea4335;">No Message ID (Cannot Delete)</div>`;
                
                emailDetailEl.innerHTML = `
                    <div class="email-detail-header">
                        <div class="email-detail-subject">${email.subject}</div>
                        <div class="email-detail-metadata">
                            <div>From: ${email.sender}</div>
                            <div>Date: ${formattedDate}</div>
                            ${messageIdInfo}
                        </div>
                        <div class="email-detail-apps">
                            <div class="email-detail-apps-title">Detected Third-Party Apps:</div>
                            <div class="email-detail-apps-list">
                                ${appTagsHtml}
                            </div>
                        </div>
                    </div>
                    <div class="email-detail-content">${sanitizedBody}</div>
                `;
            }
            
            // Add CSS for delete button if not already in the HTML
            if (!document.querySelector('style#delete-button-style')) {
                const styleEl = document.createElement('style');
                styleEl.id = 'delete-button-style';
                styleEl.textContent = `
                    .delete-button {
                        padding: 8px 16px;
                        border: none;
                        border-radius: 4px;
                        background-color: #ea4335;
                        color: white;
                        font-size: 14px;
                        cursor: pointer;
                        transition: background-color 0.2s;
                    }
                    
                    .delete-button:hover {
                        background-color: #d73125;
                    }
                    
                    .delete-button:disabled {
                        background-color: #f5a5a0;
                cursor: not-allowed;
            }
            
            /* Progress container styling */
            #delete-progress {
                padding: 25px;
                background-color: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
                text-align: center;
                min-width: 300px;
            }
            
            #delete-progress h3 {
                margin-top: 0;
                margin-bottom: 15px;
                color: #333;
            }
            
            #delete-progress-count {
                font-weight: bold;
                color: #4285f4;
            }
        `;
        document.head.appendChild(styleEl);
    }
    
    // Initialize: Start by fetching users
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM loaded, fetching users...");
        fetchUsers();
    });
    
    // Also call it immediately in case the DOM is already loaded
    if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log("Document already ready, fetching users now...");
        fetchUsers();
    }
</script>
